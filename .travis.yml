sudo: required

language:
  - cpp

services:
  - docker

matrix:
  include:
    # Certain tests are disabled on our LLVM 5 builds because they are flaky
    # when bpftrace is compiled with musl libc. They should still be capable
    # of passing occasionally.
    # String comparisons are the exception - they are just broken in debug builds.
    - name: "Static LLVM 5 Debug"
      env: LLVM_VERSION=5.0 DOCKER_BASE=alpine BUILD_TYPE=debug STATIC_LINKING=ON TEST_ARGS="--gtest_filter=codegen.*:-codegen.call_ntop_char4:codegen.call_ntop_char16:codegen.call_printf:codegen.enum_declaration:codegen.macro_definition:codegen.printf_offsets:codegen.struct_*:codegen.string_equal_comparison:codegen.string_not_equal_comparison"
    - name: "Static LLVM 5 Release"
      env: LLVM_VERSION=5.0 DOCKER_BASE=alpine BUILD_TYPE=release STATIC_LINKING=ON TEST_ARGS="--gtest_filter=codegen.*:-codegen.call_ntop_char4:codegen.call_ntop_char16:codegen.call_printf:codegen.enum_declaration:codegen.macro_definition:codegen.printf_offsets:codegen.struct_*"

    - name: "LLVM 6 Debug"
      env: LLVM_VERSION=6.0 DOCKER_BASE=bionic BUILD_TYPE=debug
    - name: "LLVM 6 Release"
      env: LLVM_VERSION=6.0 DOCKER_BASE=bionic BUILD_TYPE=release

    - name: "LLVM 7 Debug"
      env: LLVM_VERSION=7 DOCKER_BASE=bionic BUILD_TYPE=debug
    - name: "LLVM 7 Release"
      env: LLVM_VERSION=7 DOCKER_BASE=bionic BUILD_TYPE=release

    - name: "LLVM 8 Debug"
      env: LLVM_VERSION=8 DOCKER_BASE=bionic BUILD_TYPE=debug
    - name: "LLVM 8 Release"
      env: LLVM_VERSION=8 DOCKER_BASE=bionic BUILD_TYPE=release

script:
  - sudo RUN_TESTS=1 ./build.sh
