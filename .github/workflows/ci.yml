name: CI

on: [push, pull_request]

# Cancel previous run if a new one is started
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build_test:
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      matrix:
        env:
        - NAME: LLVM 14
          CMAKE_BUILD_TYPE: Debug
          NIX_TARGET: .#bpftrace-llvm14
        - NAME: LLVM 15
          CMAKE_BUILD_TYPE: Debug
          NIX_TARGET: .#bpftrace-llvm15
        - NAME: LLVM 16
          CMAKE_BUILD_TYPE: Debug
          NIX_TARGET: .#bpftrace-llvm16
        - NAME: LLVM 17
          CMAKE_BUILD_TYPE: Debug
          NIX_TARGET: .#bpftrace-llvm17
        - NAME: LLVM 18
          CMAKE_BUILD_TYPE: Debug
          NIX_TARGET: .#bpftrace-llvm18
        - NAME: LLVM 19 Release
          CMAKE_BUILD_TYPE: Release
          NIX_TARGET: .#bpftrace-llvm19
        - NAME: LLVM 19 Debug
          CMAKE_BUILD_TYPE: Debug
          NIX_TARGET: .#bpftrace-llvm19
        - NAME: LLVM 19 Clang Debug
          CMAKE_BUILD_TYPE: Debug
          NIX_TARGET: .#bpftrace-llvm19
          CC: clang
          CXX: clang++
    steps:
    - uses: actions/checkout@v2
    - uses: DeterminateSystems/nix-installer-action@v11
    - uses: DeterminateSystems/magic-nix-cache-action@v6
    - name: Load kernel modules
      # nf_tables and xfs are necessary for testing kernel modules BTF support
      run: |
        sudo modprobe nf_tables
        sudo modprobe xfs
    - name: Build and test
      env: ${{matrix.env}}
      run: ./.github/include/ci.py
